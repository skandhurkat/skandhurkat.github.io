<!DOCTYPE html>
<html lang="en-us">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="theme" content="cornellcsl">
  <meta name="generator" content="Hugo 0.27" />
  <meta name="author" content="Skand Hurkat">
  <meta name="description" content="PhD Candidate">

  
  
  
    
  
  
    
    
    <link rel="stylesheet" href="/css/highlight.min.css">
    
  
  <link rel="stylesheet" href="/css/bootstrap.min.css">
  <link rel="stylesheet" href="/css/font-awesome.min.css">
  <link rel="stylesheet" href="/css/academicons.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Lato:400,700%7cMerriweather%7cRoboto&#43;Mono">
  <link rel="stylesheet" href="/css/cornellcsl.min.css">
  

  <link rel="alternate" href="http://skandhurkat.github.io/index.xml" type="application/rss+xml" title="Skand Hurkat – Computer Systems Lab, Cornell University">

  <link rel="icon" type="image/png" href="/img/CULogo-red120px.png">
  <link rel="apple-touch-icon" type="image/png" href="/img/CULogo-red120px.png">

  <link rel="canonical" href="http://skandhurkat.github.io/post/makefile-dependencies/">

  

  <title>Handling dependencies in Makefiles | Skand Hurkat – Computer Systems Lab, Cornell University</title>

  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
  <script async src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
  <script defer>
  window.addEventListener("load", function(){
  window.cookieconsent.initialise({
    "palette": {
      "popup": {
        "background": "#ffffff",
        "text": "#000000"
      },
      "button": {
        "background": "#b31b1b",
        "text": "#ffffff"
      }
    },
    "showLink": false,
    "content": {
      "message": "This website uses cookies for analytics and to enable comments.",
      "dismiss": "Cool! I get it."
    }
  })});
  </script>
</head>
<body data-spy="scroll" data-target="#navbar-main" data-offset="71">

    
    <a class="sr-only" href="#content">Skip to main content</a>
    <header id="top" class="cu-banner">
    
    <div class="container">
        <form action="//www.google.com/search" id="cu-search"
        method="get" role="search" class="collapse">
        
        
        
         
        <input type="hidden" name="q"
        value="site:people.ece.cornell.edu/skand">
        <div class="input-group col-xs-12">
            
            <input autocomplete="off" id="search-query" name="q"
            placeholder="Search this website using Google"
            required type="search" class="col-xs-12 cu-search-box">
            <label for="search-query" class="sr-only">
                 Search this website using Google
            </label>
        </div>
        </form>
    </div>
    
    <div class="container">
        <div class="row">
            <div class="col-xs-10 cu-csl-logo-div">
	    
                <a href="//www.csl.cornell.edu" target="_blank">
            
		    <img src="/img/org-logo.svg"
		        class="img-responsive"
                        alt="Computer Systems Lab, Cornell University"
		        style="margin: 0;" />
            
                </a>
            
            </div>
	    
            <div class="col-xs-2 col-middle cu-search-toggle-div">
                <span class="pull-right">
                    <button class="btn btn-cu-banner" type="button"
                    data-toggle="collapse" data-target="#cu-search"
                    id="cu-search-toggle" style="position:relative;">
                        <span class="sr-only">Toggle search</span>
                        <span class="cu-search-toggle glyphicon glyphicon-search">
                        </span>
                    </button>
                </span>
            </div>
	    
        </div>
    </div>
    </header>


<div class="nav-wrapper">
<nav class="navbar navbar-default" id="navbar-main">
  <div class="container">

    
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
              data-target=".navbar-collapse" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">Skand Hurkat</a>
    </div>

    
    <div class="collapse navbar-collapse">

      
      <ul class="nav navbar-nav navbar-right">
        

        

        <li class="nav-item">
          <a href="/#about">
            
            <span>Home</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#publications">
            
            <span>Publications</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#posts">
            
            <span>Posts</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#projects">
            
            <span>Projects</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#teaching">
            
            <span>Teaching</span>
          </a>
        </li>

        
        

        

        <li class="nav-item">
          <a href="/#contact">
            
            <span>Contact</span>
          </a>
        </li>

        
        
      </ul>

    </div>
  </div>
</nav>
</div>


<article class="article" itemscope itemtype="http://schema.org/BlogPosting">

  

  <div class="article-container">
    <h1 itemprop="name headline">Handling dependencies in Makefiles</h1>
    

<div class="article-metadata">

  
  by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name" class="article-authors">Skand Hurkat</span></span>.
  
  <span class="article-date">
    <time datetime="2017-08-02T17:45:00-04:00" itemprop="datePublished">
      Wed, Aug 2, 2017
    </time>
  </span>

  

  
  
  
  <span class="article-tags">
    <i class="fa fa-tags"></i>
    
    <a href="/tags/makefiles">makefiles</a
    >, 
    
    <a href="/tags/programming">programming</a
    >
    
  </span>
  
  

  
  
<div class="share-box" aria-hidden="true">
  <ul class="share">
    <li>
      <a class="facebook"
         href="https://www.facebook.com/sharer.php?u=http%3a%2f%2fskandhurkat.github.io%2fpost%2fmakefile-dependencies%2f"
         target="_blank">
        <i class="fa fa-facebook"></i>
      </a>
    </li>
    <li>
      <a class="twitter"
         href="https://twitter.com/intent/tweet?text=Handling%20dependencies%20in%20Makefiles&amp;url=http%3a%2f%2fskandhurkat.github.io%2fpost%2fmakefile-dependencies%2f"
         target="_blank">
        <i class="fa fa-twitter"></i>
      </a>
    </li>
    <li>
      <a class="linkedin"
         href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2fskandhurkat.github.io%2fpost%2fmakefile-dependencies%2f&amp;title=Handling%20dependencies%20in%20Makefiles"
         target="_blank">
        <i class="fa fa-linkedin"></i>
      </a>
    </li>
    <li>
      <a class="weibo"
         href="http://service.weibo.com/share/share.php?url=http%3a%2f%2fskandhurkat.github.io%2fpost%2fmakefile-dependencies%2f&amp;title=Handling%20dependencies%20in%20Makefiles"
         target="_blank">
        <i class="fa fa-weibo"></i>
      </a>
    </li>
    <li>
      <a class="email"
         href="mailto:?subject=Handling%20dependencies%20in%20Makefiles&amp;body=http%3a%2f%2fskandhurkat.github.io%2fpost%2fmakefile-dependencies%2f">
        <i class="fa fa-envelope"></i>
      </a>
    </li>
  </ul>
</div>


  

</div>

    <div class="article-style" itemprop="articleBody">
      <p>I&rsquo;ve seen way too many projects that supply a makefile that requires the
user to run <code>make clean</code> and <code>make</code> every single time they make a
change to some file. This is annoying and error prone, and the good news
is that it can be easily solved with this one simple trick. Use a good
build-generation system like <a href="//cmake.org" target="_blank">CMake</a> instead.</p>

<p></p>

<p>Still here? Well, since you asked, I shall tell.</p>

<p>The trick is to have your compiler spit out a list of dependencies for
each source file.</p>

<p>Try it out right now. Start a terminal and go to any project that is
sufficiently complex to have multiple include chains in a C or C++
source file (<code>foo.cc</code>). Then type in this command</p>
<div class="highlight" style="background: #000000"><pre style="line-height: 125%">$&gt; g++ -M foo.cc
</pre></div>

<p>The output is a list of all the files that are included by the source
file, including standard library headers. If you look closer, the output
is formatted so that it follows the same syntax as <code>make</code> for declaring
dependencies. But we really don&rsquo;t want to be bothered with system header
files, so instead, we&rsquo;ll use the <code>g++ -MM</code>.</p>

<p>Cool, isn&rsquo;t it? This means that all we now need to do is to find a way
to include this information in our Makefile, and have it automatically
update any time the source files are changed. So here&rsquo;s the recipe.</p>
<div class="highlight" style="background: #000000"><pre style="line-height: 125%"><span style="color: #000080"># List of source files here.</span>
<span style="color: #00cdcd">sources</span> <span style="color: #3399cc">=</span> foo.cc bar.cc

<span style="color: #000080"># Add C++ flags, for example, if the code uses C++11 standards.</span>
<span style="color: #00cdcd">CPPFLAGS</span> <span style="color: #3399cc">=</span> -std<span style="color: #3399cc">=</span>c++11

<span style="color: #000080"># Recipe for making .d files from .cc files</span>
<span style="color: #cccccc">%.d</span><span style="color: #3399cc">:</span> %.<span style="color: #cccccc">cc</span>
	<span style="color: #cdcd00">$(</span>CC<span style="color: #cdcd00">)</span> -MM <span style="color: #cdcd00">$(</span>CPPFLAGS<span style="color: #cdcd00">)</span> -o <span style="color: #00cdcd">$@</span> $&lt;

<span style="color: #000080"># Include the required .d files in the current Makefile.</span>
<span style="color: #000080">include $(sources:.cc=.d)</span>

<span style="color: #000080"># Recipe for making .o files. Here, I introduce a dependency on the</span>
<span style="color: #000080"># primary source c++ file.</span>
<span style="color: #cccccc">%.o</span><span style="color: #3399cc">:</span> %.<span style="color: #cccccc">cc</span>
	<span style="color: #cdcd00">$(</span>CC<span style="color: #cdcd00">)</span> -c <span style="color: #cdcd00">$(</span>CPPFLAGS<span style="color: #cdcd00">)</span> -o <span style="color: #00cdcd">$@</span> <span style="color: #cdcd00">$(</span>&lt;:.d<span style="color: #3399cc">=</span>.cc<span style="color: #cdcd00">)</span>
</pre></div>

<p>Of course, there&rsquo;s a bug in this recipe as well. Can you spot it? While
you think about the bug, enjoy this picture of the gorge at Watkins Glen
state park, which is under thirty miles from Cornell University.</p>

<blockquote class="instagram-media" data-instgrm-version="7" style=" background:#FFF; border:0; border-radius:3px; box-shadow:0 0 1px 0 rgba(0,0,0,0.5),0 1px 10px 0 rgba(0,0,0,0.15); margin: 1px; max-width:658px; padding:0; width:99.375%; width:-webkit-calc(100% - 2px); width:calc(100% - 2px);"><div style="padding:8px;"> <div style=" background:#F8F8F8; line-height:0; margin-top:40px; padding:50.0% 0; text-align:center; width:100%;"> <div style=" background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACwAAAAsCAMAAAApWqozAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAAMUExURczMzPf399fX1+bm5mzY9AMAAADiSURBVDjLvZXbEsMgCES5/P8/t9FuRVCRmU73JWlzosgSIIZURCjo/ad+EQJJB4Hv8BFt+IDpQoCx1wjOSBFhh2XssxEIYn3ulI/6MNReE07UIWJEv8UEOWDS88LY97kqyTliJKKtuYBbruAyVh5wOHiXmpi5we58Ek028czwyuQdLKPG1Bkb4NnM+VeAnfHqn1k4+GPT6uGQcvu2h2OVuIf/gWUFyy8OWEpdyZSa3aVCqpVoVvzZZ2VTnn2wU8qzVjDDetO90GSy9mVLqtgYSy231MxrY6I2gGqjrTY0L8fxCxfCBbhWrsYYAAAAAElFTkSuQmCC); display:block; height:44px; margin:0 auto -44px; position:relative; top:-22px; width:44px;"></div></div><p style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; line-height:17px; margin-bottom:0; margin-top:8px; overflow:hidden; padding:8px 0 7px; text-align:center; text-overflow:ellipsis; white-space:nowrap;"><a href="https://www.instagram.com/p/BNf_cb4gP2k/" style=" color:#c9c8cd; font-family:Arial,sans-serif; font-size:14px; font-style:normal; font-weight:normal; line-height:17px; text-decoration:none;" target="_blank">A post shared by Skand Hurkat (@skandhurkat)</a> on <time style=" font-family:Arial,sans-serif; font-size:14px; line-height:17px;" datetime="2016-12-02T03:35:13+00:00">Dec 1, 2016 at 7:35pm PST</time></p></div></blockquote>
<script async defer src="//platform.instagram.com/en_US/embeds.js"></script>

<p>The bug is that the <code>.d</code> files do not update if something changes in the
include chain. However, the GNU Make manual has <a href="https://www.gnu.org/software/make/manual/make.html#Generating-Prerequisites-Automatically" target="_blank">an interesting
fix</a>.</p>

<p>Their solution is to use <code>sed</code> to introduce the same dependency chain as
for the <code>.o</code> file into the <code>.d</code> file. Here&rsquo;s the updated Makefile with
their recipe.</p>
<div class="highlight" style="background: #000000"><pre style="line-height: 125%"><span style="color: #000080"># List of source files here.</span>
<span style="color: #00cdcd">sources</span> <span style="color: #3399cc">=</span> foo.cc bar.cc

<span style="color: #000080"># Add C++ flags, for example, if the code uses C++11 standards.</span>
<span style="color: #00cdcd">CPPFLAGS</span> <span style="color: #3399cc">=</span> -std<span style="color: #3399cc">=</span>c++11

<span style="color: #000080"># Recipe for making .d files from .cc files. This has been updated from</span>
<span style="color: #000080"># the GNU Make manual</span>
<span style="color: #cccccc">%.d</span><span style="color: #3399cc">:</span> %.<span style="color: #cccccc">cc</span>
	<span style="color: #cdcd00">$(</span>CC<span style="color: #cdcd00">)</span> -MM <span style="color: #cdcd00">$(</span>CPPFLAGS<span style="color: #cdcd00">)</span> $&lt; &gt; <span style="color: #00cdcd">$@</span>.<span style="color: #00cdcd">$$$$</span><span style="color: #cccccc">;</span> <span style="color: #cd0000">\</span>
	sed <span style="color: #cd0000">&#39;s,\($*\)\.o[ :]*,\1.o $@ : ,g&#39;</span> &lt; <span style="color: #00cdcd">$@</span>.<span style="color: #00cdcd">$$$$</span> &gt; <span style="color: #00cdcd">$@</span><span style="color: #cccccc">;</span> <span style="color: #cd0000">\</span>
	rm -f <span style="color: #00cdcd">$@</span>.<span style="color: #00cdcd">$$$$</span>

<span style="color: #000080"># Include the required .d files in the current Makefile.</span>
<span style="color: #000080">include $(sources:.cc=.d)</span>

<span style="color: #000080"># Recipe for making .o files. Here, I introduce a dependency on the</span>
<span style="color: #000080"># primary source c++ file.</span>
<span style="color: #cccccc">%.o</span><span style="color: #3399cc">:</span> %.<span style="color: #cccccc">cc</span>
	<span style="color: #cdcd00">$(</span>CC<span style="color: #cdcd00">)</span> -c <span style="color: #cdcd00">$(</span>CPPFLAGS<span style="color: #cdcd00">)</span> -o <span style="color: #00cdcd">$@</span> <span style="color: #cdcd00">$(</span>&lt;:.d<span style="color: #3399cc">=</span>.cc<span style="color: #cdcd00">)</span>
</pre></div>

<p>Okay, I think that should work now. But it does beg the question, why
are we even writing Makefiles by hand any more? Shouldn&rsquo;t we just use a
configuration system like CMake or GNU Autotools that can generate
correct Makefiles?</p>
    </div>
  </div>

</article>

<div class="container">
  <nav>
  <ul class="pager">
    
    <li class="previous"><a href="http://skandhurkat.github.io/post/net-neutrality/"><span
      aria-hidden="true">&larr;</span> Net Neutrality</a></li>
    

    
    <li class="next"><a href="http://skandhurkat.github.io/post/intro-to-cmake/">Introduction to CMake <span
      aria-hidden="true">&rarr;</span></a></li>
    
  </ul>
</nav>

</div>

<div class="article-container">
  
<section id="comments">
  <div id="disqus_thread">
    <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "skandhurkat-csl" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
</section>


</div>



    <script defer src="//cdnjs.cloudflare.com/ajax/libs/gsap/1.18.4/TweenMax.min.js"></script>
    <script defer src="//cdnjs.cloudflare.com/ajax/libs/gsap/latest/plugins/ScrollToPlugin.min.js"></script>
    <script defer src="/js/jquery-1.12.3.min.js"></script>
    <script defer src="/js/jquery.easing.min.js"></script>
    <script defer src="/js/bootstrap.min.js"></script>
    <script defer src="/js/isotope.pkgd.min.js"></script>
    <script defer src="//cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.1/imagesloaded.pkgd.min.js"></script>
    <script defer src="/js/cornellcsl.min.js"></script>
    

    
    <script defer>
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
        ga('create', 'UA-25068733-5', 'auto');
        ga('send', 'pageview');

         
        var links = document.querySelectorAll('a');
        Array.prototype.map.call(links, function(item) {
            if (item.host != document.location.host) {
                item.addEventListener('click', function() {
                    var action = item.getAttribute('data-action') || 'follow';
                    ga('send', 'event', 'outbound', action, item.href);
                });
            }
        });
    </script>
    

    
    
      
      <script defer src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

      

      

      <script>hljs.initHighlightingOnLoad();</script>
    

    
    

  </body>
</html>

